{"version":3,"file":"index.js","sourceRoot":"","sources":["../src/index.ts"],"names":[],"mappings":"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","sourcesContent":["import { Output } from '@jfonx/console-utils';\nimport { watch } from 'chokidar';\nimport { existsSync, readFileSync, writeFileSync } from 'fs';\nimport { sync } from 'globby';\nimport * as normalizePath from 'normalize-path';\nimport {\n  basename,\n  dirname,\n  isAbsolute,\n  normalize,\n  relative,\n  resolve\n} from 'path';\nimport {\n  existsResolvedAlias,\n  getAbsoluteAliasPath,\n  getProjectDirPathInOutDir,\n  loadConfig\n} from './helpers';\n\nexport function replaceTscAliasPaths(\n  options: {\n    configFile?: string;\n    outDir?: string;\n    watch?: boolean;\n  } = {\n    watch: false\n  }\n) {\n  Output.info('=== tsc-alias starting ===');\n  if (!options.configFile) {\n    options.configFile = resolve(process.cwd(), 'tsconfig.json');\n  } else {\n    if (!isAbsolute(options.configFile)) {\n      options.configFile = resolve(process.cwd(), options.configFile);\n    }\n  }\n\n  const configFile = options.configFile;\n\n  if (!existsSync(configFile)) {\n    Output.error(`Invalid file path => ${configFile}`, true);\n  }\n\n  let { baseUrl, outDir, paths } = loadConfig(configFile);\n  if (options.outDir) {\n    outDir = options.outDir;\n  }\n\n  if (!baseUrl) {\n    Output.error('compilerOptions.baseUrl is not set', true);\n  }\n  if (!paths) {\n    Output.error('compilerOptions.paths is not set', true);\n  }\n  if (!outDir) {\n    Output.error('compilerOptions.outDir is not set', true);\n  }\n\n  const configDir: string = normalizePath(dirname(configFile));\n\n  const outPath = normalizePath(normalize(configDir + '/' + outDir));\n\n  const confDirParentFolderName: string = basename(configDir);\n\n  let hasExtraModule = false;\n  let configDirInOutPath: string = null;\n  let relConfDirPathInOutPath;\n\n  const aliases = Object.keys(paths)\n    .map((alias) => {\n      const _paths = paths[alias as keyof typeof paths].map((path) => {\n        path = path.replace(/\\*$/, '').replace('.t', '.j');\n        if (isAbsolute(path)) {\n          path = relative(configDir, path);\n        }\n        return path;\n      });\n\n      const path = _paths[0];\n\n      const isExtra = null;\n      const basePath = null;\n      if (normalize(path).includes('..')) {\n        if (!configDirInOutPath) {\n          configDirInOutPath = getProjectDirPathInOutDir(\n            outPath,\n            confDirParentFolderName\n          );\n          if (configDirInOutPath) {\n            hasExtraModule = true;\n          }\n\n          // Find relative path access of configDir in outPath\n          if (configDirInOutPath) {\n            const stepsbackPath = relative(configDirInOutPath, outPath);\n            const splitStepBackPath = normalizePath(stepsbackPath).split('/');\n            const nbOfStepBack = splitStepBackPath.length;\n            const splitConfDirInOutPath = configDirInOutPath.split('/');\n\n            let i = 1;\n            const splitRelPath: string[] = [];\n            while (i <= nbOfStepBack) {\n              splitRelPath.unshift(\n                splitConfDirInOutPath[splitConfDirInOutPath.length - i]\n              );\n              i++;\n            }\n            relConfDirPathInOutPath = splitRelPath.join('/');\n          }\n        }\n      }\n\n      let prefix = alias.replace(/\\*$/, '');\n      if (prefix[prefix.length - 1] === '/') {\n        prefix = prefix.substring(0, prefix.length - 1);\n      }\n      return {\n        prefix,\n        basePath,\n        path,\n        paths: _paths,\n        isExtra\n      };\n    })\n    .filter(({ prefix }) => prefix);\n\n  /*********** Find basepath of aliases *****************/\n  aliases.forEach((alias) => {\n    if (normalize(alias.path).includes('..')) {\n      const tempBasePath = normalizePath(\n        normalize(\n          `${configDir}/${outDir}/${\n            hasExtraModule && relConfDirPathInOutPath\n              ? relConfDirPathInOutPath\n              : ''\n          }/${baseUrl}`\n        )\n      );\n\n      const absoluteBasePath = normalizePath(\n        normalize(`${tempBasePath}/${alias.path}`)\n      );\n      if (existsResolvedAlias(absoluteBasePath)) {\n        alias.isExtra = false;\n        alias.basePath = tempBasePath;\n      } else {\n        alias.isExtra = true;\n        alias.basePath = absoluteBasePath;\n      }\n    } else if (hasExtraModule) {\n      alias.isExtra = false;\n      alias.basePath = normalizePath(\n        normalize(\n          `${configDir}/${outDir}/${relConfDirPathInOutPath}/${baseUrl}`\n        )\n      );\n    } else {\n      alias.basePath = normalizePath(normalize(`${configDir}/${outDir}`));\n      alias.isExtra = false;\n    }\n  });\n\n  const requireRegex = /(?:import|require)\\(['\"]([^'\"]*)['\"]\\)/g;\n  const importRegex = /(?:import|from) ['\"]([^'\"]*)['\"]/g;\n\n  const replaceImportStatement = ({\n    orig,\n    file,\n    alias\n  }: {\n    orig: string;\n    file: string;\n    alias: typeof aliases[0];\n  }): string => {\n    const requiredModule = orig.split(/\"|'/)[1];\n    const index = orig.indexOf(alias.prefix);\n    const isAlias = requiredModule.includes('/')\n      ? requiredModule.startsWith(alias.prefix + '/')\n      : requiredModule.startsWith(alias.prefix);\n    if (index > -1 && isAlias) {\n      let absoluteAliasPath = getAbsoluteAliasPath(alias.basePath, alias.path);\n      let relativeAliasPath: string = normalizePath(\n        relative(dirname(file), absoluteAliasPath)\n      );\n\n      if (!relativeAliasPath.startsWith('.')) {\n        relativeAliasPath = './' + relativeAliasPath;\n      }\n\n      const modulePath =\n        orig.substring(0, index) +\n        relativeAliasPath +\n        orig.substring(index + alias.prefix.length);\n\n      return modulePath.replace(/\\/\\//g, '/');\n    }\n    return orig;\n  };\n\n  const replaceAlias = (file: string): boolean => {\n    const code = readFileSync(file, 'utf8');\n    let tempCode = code;\n    for (const alias of aliases) {\n      const replacementParams = {\n        file,\n        alias\n      };\n      tempCode = tempCode\n        .replace(requireRegex, (orig) =>\n          replaceImportStatement({\n            orig,\n            ...replacementParams\n          })\n        )\n        .replace(importRegex, (orig) =>\n          replaceImportStatement({\n            orig,\n            ...replacementParams\n          })\n        );\n    }\n    if (code !== tempCode) {\n      writeFileSync(file, tempCode, 'utf8');\n      return true;\n    }\n    return false;\n  };\n\n  // Finding files and changing alias paths\n  const globPattern = [\n    `${outPath}/**/*.{js,jsx,ts,tsx}`,\n    `!${outPath}/**/node_modules`\n  ];\n  const files = sync(globPattern, {\n    dot: true,\n    onlyFiles: true\n  });\n\n  const flen = files.length;\n  let replaceCount = 0;\n  for (let i = 0; i < flen; i += 1) {\n    const file = files[i];\n    if (replaceAlias(file)) {\n      replaceCount++;\n    }\n  }\n\n  Output.info(`${replaceCount} files were affected!`);\n  if (options.watch) {\n    Output.info('[Watching for file changes...]');\n    const filesWatcher = watch(globPattern);\n    const tsconfigWatcher = watch(configFile);\n    filesWatcher.on('change', (file) => {\n      replaceAlias(file);\n    });\n    tsconfigWatcher.on('change', (_) => {\n      Output.clear();\n      filesWatcher.close();\n      tsconfigWatcher.close();\n      replaceTscAliasPaths(options);\n    });\n  }\n}\n"]}